(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function t(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(i){if(i.ep)return;i.ep=!0;const s=t(i);fetch(i.href,s)}})();class l{constructor(){this.isRunning=!1,this.isPaused=!1,this.isWorkSession=!0,this.timeRemaining=90*60,this.totalSessionTime=90*60,this.sessionCount=0,this.eyeRestInterval=null,this.eyeRestActive=!1,this.eyeRestCountdown=20,this.settings={workDuration:90,breakDuration:20,soundEnabled:!0,notificationsEnabled:!0},this.audioContext=null,this.mainTimer=null,this.eyeRestTimer=null,this.nextEyeRestTimeout=null,this.init()}init(){this.loadSettings(),this.initializeAds(),setTimeout(()=>{this.bindEvents()},50),this.updateDisplay(),this.scheduleNextEyeRest(),this.requestNotificationPermission()}initializeAds(){setTimeout(()=>{try{(adsbygoogle=window.adsbygoogle||[]).push({}),(adsbygoogle=window.adsbygoogle||[]).push({}),console.log("AdSense ads initialized")}catch{console.log("AdSense not available or blocked")}},1e3)}loadSettings(){const e=localStorage.getItem("focusClockSettings");e&&(this.settings={...this.settings,...JSON.parse(e)}),this.applySettings()}saveSettings(){localStorage.setItem("focusClockSettings",JSON.stringify(this.settings))}applySettings(){document.getElementById("soundEnabled").checked=this.settings.soundEnabled,document.getElementById("notificationsEnabled").checked=this.settings.notificationsEnabled,document.getElementById("workDuration").value=this.settings.workDuration,document.getElementById("breakDuration").value=this.settings.breakDuration,this.isRunning||(this.isWorkSession?(this.timeRemaining=this.settings.workDuration*60,this.totalSessionTime=this.settings.workDuration*60):(this.timeRemaining=this.settings.breakDuration*60,this.totalSessionTime=this.settings.breakDuration*60),this.updateDisplay())}bindEvents(){const e=(t,o,i)=>{const s=document.getElementById(t);return s?(s.addEventListener(o,i),console.log(`Event listener added for ${t}`),!0):(console.warn(`Element with ID '${t}' not found`),!1)};e("startPauseBtn","click",()=>this.toggleTimer()),e("resetBtn","click",()=>this.resetTimer()),e("settingsBtn","click",()=>this.openSettings()),e("instructionsHeader","click",()=>this.toggleInstructions()),e("toggleInstructions","click",t=>{t.stopPropagation(),this.toggleInstructions()}),e("closeSettings","click",t=>{t.preventDefault(),t.stopPropagation(),console.log("Close settings button clicked"),this.closeSettings()}),e("closeSettingsX","click",t=>{t.preventDefault(),t.stopPropagation(),console.log("Close settings X button clicked"),this.closeSettings()}),e("soundEnabled","change",t=>{this.settings.soundEnabled=t.target.checked,this.saveSettings()}),e("notificationsEnabled","change",t=>{this.settings.notificationsEnabled=t.target.checked,this.saveSettings()}),e("workDuration","change",t=>{this.settings.workDuration=parseInt(t.target.value),this.saveSettings(),this.applySettings()}),e("breakDuration","change",t=>{this.settings.breakDuration=parseInt(t.target.value),this.saveSettings(),this.applySettings()}),e("skipEyeRest","click",()=>this.skipEyeRest()),document.addEventListener("click",t=>{t.target.classList.contains("modal")&&!t.target.closest(".modal-content")&&t.target.classList.add("hidden")}),document.addEventListener("keydown",t=>{t.code==="Space"&&!t.target.matches("input, select, button")?(t.preventDefault(),this.toggleTimer()):t.code==="Escape"&&this.closeAllModals()})}toggleTimer(){this.isRunning?this.pauseTimer():this.startTimer()}startTimer(){this.isRunning=!0,this.isPaused=!1,document.getElementById("startPauseBtn").textContent="暫停",document.querySelector(".timer-circle").classList.add("active"),this.mainTimer=setInterval(()=>{this.timeRemaining--,this.updateDisplay(),this.timeRemaining<=0&&this.completeSession()},1e3),this.isWorkSession&&this.scheduleNextEyeRest()}pauseTimer(){this.isRunning=!1,this.isPaused=!0,document.getElementById("startPauseBtn").textContent="繼續",document.querySelector(".timer-circle").classList.remove("active"),this.mainTimer&&(clearInterval(this.mainTimer),this.mainTimer=null),this.nextEyeRestTimeout&&(clearTimeout(this.nextEyeRestTimeout),this.nextEyeRestTimeout=null)}resetTimer(){this.isRunning=!1,this.isPaused=!1,this.mainTimer&&(clearInterval(this.mainTimer),this.mainTimer=null),this.nextEyeRestTimeout&&(clearTimeout(this.nextEyeRestTimeout),this.nextEyeRestTimeout=null),this.isWorkSession?(this.timeRemaining=this.settings.workDuration*60,this.totalSessionTime=this.settings.workDuration*60):(this.timeRemaining=this.settings.breakDuration*60,this.totalSessionTime=this.settings.breakDuration*60),document.getElementById("startPauseBtn").textContent="開始",document.querySelector(".timer-circle").classList.remove("active"),this.updateDisplay()}completeSession(){this.isRunning=!1,this.mainTimer&&(clearInterval(this.mainTimer),this.mainTimer=null),this.isWorkSession?(this.sessionCount++,this.isWorkSession=!1,this.timeRemaining=this.settings.breakDuration*60,this.totalSessionTime=this.settings.breakDuration*60,this.showNotification("工作時間結束！","時間休息一下吧 🎉"),this.playNotificationSound()):(this.isWorkSession=!0,this.timeRemaining=this.settings.workDuration*60,this.totalSessionTime=this.settings.workDuration*60,this.showNotification("休息結束！","準備開始新的工作週期 💪"),this.playNotificationSound()),document.getElementById("startPauseBtn").textContent="開始",document.querySelector(".timer-circle").classList.remove("active"),this.updateDisplay(),this.updateProgress()}scheduleNextEyeRest(){if(!this.isWorkSession||!this.isRunning)return;const e=Math.floor(Math.random()*121)+180;this.nextEyeRestTimeout=setTimeout(()=>{this.isRunning&&this.isWorkSession&&this.showEyeRest()},e*1e3)}showEyeRest(){this.eyeRestActive||(this.eyeRestActive=!0,this.eyeRestCountdown=20,document.getElementById("eyeRestModal").classList.remove("hidden"),document.getElementById("eyeRestCountdown").textContent=this.eyeRestCountdown,this.playNotificationSound(),this.showNotification("護眼休息時間！","請閉上眼睛休息 20 秒 👁️"),this.eyeRestTimer=setInterval(()=>{this.eyeRestCountdown--,document.getElementById("eyeRestCountdown").textContent=this.eyeRestCountdown,this.eyeRestCountdown<=0&&this.endEyeRest()},1e3))}endEyeRest(){this.eyeRestActive=!1,this.eyeRestTimer&&(clearInterval(this.eyeRestTimer),this.eyeRestTimer=null),document.getElementById("eyeRestModal").classList.add("hidden"),this.scheduleNextEyeRest()}skipEyeRest(){this.endEyeRest()}updateDisplay(){const e=Math.floor(this.timeRemaining/60),t=this.timeRemaining%60,o=`${e}:${t.toString().padStart(2,"0")}`;document.getElementById("timeDisplay").textContent=o;const i=this.isWorkSession?"專注時間":"休息時間",s=this.isRunning?this.isWorkSession?"工作中":"休息中":"準備中";document.getElementById("sessionType").textContent=i,document.getElementById("phaseDisplay").textContent=s;const a=document.getElementById("sessionType");a.style.background=this.isWorkSession?"var(--primary-color)":"var(--secondary-color)",document.title=`${o} - ${i} - 專注時鐘`}updateProgress(){document.getElementById("completedSessions").textContent=this.sessionCount;const t=Math.min(this.sessionCount/4*100,100);document.getElementById("progressFill").style.width=`${t}%`}openSettings(){document.getElementById("settingsModal").classList.remove("hidden")}closeSettings(){console.log("closeSettings method called");const e=document.getElementById("settingsModal");e?(e.classList.add("hidden"),console.log("Settings modal closed successfully")):console.error("Settings modal not found!")}closeAllModals(){document.querySelectorAll(".modal").forEach(e=>{e.classList.add("hidden")})}async requestNotificationPermission(){"Notification"in window&&this.settings.notificationsEnabled&&Notification.permission==="default"&&await Notification.requestPermission()}showNotification(e,t){this.settings.notificationsEnabled&&"Notification"in window&&Notification.permission==="granted"&&new Notification(e,{body:t,icon:"/clock.svg",tag:"focus-clock"})}async playNotificationSound(){if(this.settings.soundEnabled)try{this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext));const e=this.audioContext.createOscillator(),t=this.audioContext.createGain();e.connect(t),t.connect(this.audioContext.destination),e.frequency.setValueAtTime(520,this.audioContext.currentTime),t.gain.setValueAtTime(.05,this.audioContext.currentTime),t.gain.exponentialRampToValueAtTime(.005,this.audioContext.currentTime+.8),e.start(this.audioContext.currentTime),e.stop(this.audioContext.currentTime+.8)}catch(e){console.log("Audio not available:",e)}}toggleInstructions(){const e=document.getElementById("instructionsContent"),t=document.getElementById("toggleInstructions");e.classList.contains("expanded")?(e.classList.remove("expanded"),t.textContent="展開"):(e.classList.add("expanded"),t.textContent="收起")}}document.addEventListener("DOMContentLoaded",()=>{console.log("DOM loaded, initializing FocusClock..."),setTimeout(()=>{const n=new l;window.app=n,console.log("FocusClock initialized successfully")},100),window.closeSettingsModal=function(){console.log("Global close function called");const n=document.getElementById("settingsModal");n&&(n.classList.add("hidden"),n.style.display="none",console.log("Modal closed via global function"))}});"serviceWorker"in navigator&&navigator.serviceWorker.register("/sw.js").catch(console.error);
